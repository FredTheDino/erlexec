<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<!-- HEAD -->
  <link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/github-dark-dimmed.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/languages/erlang.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>
<body>
<a name="top"></a>
<div class="navcontainer">
  <div class="navbar">
    <div class="dropdown">
      <i class="fa fa-bars dropbtn"></i>
      <div class="dropdown-content">
<a class="mod" href="exec_app.html">exec_app</a>
<a class="mod" href="exec.html">exec</a>
      </div>
    </div>
    <a class="mod" href="index.html">Overview</a>
    <!-- MODULE MENU BEGIN -->
    <a class="mod" href="#top">Description</a>
    <a class="mod" href="#types">Data Types</a>
    <a class="mod" href="#index">Function Index</a>
    <a class="mod" href="#functions">Function Details</a>
    <!-- MODULE MENU END -->
  </div>
</div>
<div class="main">
<a name="top"></a>
<hr>

<h1>Module exec</h1>

<p><b>Version:</b> e090b069b079eba57f092143e279fb208131ecb7</p>
<p><b>Behaviours:</b> <a href="gen_server.html"><tt>gen_server</tt></a>.</p>
<p><b>Authors:</b> Serge Aleynikov (<a href="mailto:saleyn@gmail.com"><tt>saleyn@gmail.com</tt></a>).</p>

<h2><a href="#top" name="description">Description</a></h2><p>OS shell command runner.
        It communicates with a separate C++ port process <code>exec-port</code>        
spawned by this module, which is responsible        
for starting, killing, listing, terminating, and notifying of        
state changes.</p>
  
        The port program serves as a middle-man between
        the OS and the virtual machine to carry out OS-specific low-level
        process control.  The Erlang/C++ protocol is described in the
        <code>exec.cpp</code> file.  The <code>exec</code> application can execute tasks by
        impersonating as a different effective user.  This impersonation
        can be accomplished in one of the following two ways (assuming
        that the emulator is not running as <code>root</code>:
        <ul>
        <li>Having the user account running the erlang emulator added to
            the <code>/etc/sudoers</code> file, so that it can execute <code>exec-port</code>
            task as <code>root</code>. (Preferred option)</li>
        <li>Setting <code>root</code> ownership on <code>exec-port</code>, and setting the
            SUID bit: <code>chown root:root exec-port; chmod 4755 exec-port</code>.
            (This option is discouraged as it's less secure).</li>
        </ul><p>
        In either of these two cases, <code>exec:start_link/2</code> must be started
        with options <code>[root, {user, User}, {limit_users, Users}]</code>,
        so that <code>exec-port</code> process will not actually run as
        root but will switch to the effective <code>User</code>, and set the kernel
        capabilities so that it's able to start processes as other
        effective users given in the <code>Users</code> list and adjust process        
priorities.</p>
  
        <p>Though, in the initial design, <code>exec</code> prohibited such use, upon
        user requests a feature was added (in order to support <code>docker</code>
        deployment and CI testing) to be able to execute <code>exec-port</code> as
        <code>root</code> without switching the effective user to anying other than
        <code>root</code>. To accomplish this use the following options to start
        <code>exec</code>: <code>[root, {user, "root"}, {limit_users, ["root"]}]</code>.</p>
  
        At exit the port program makes its best effort to perform
        clean shutdown of all child OS processes.
        Every started OS process is linked to a spawned light-weight
        Erlang process returned by the run/2, run_link/2 command.
        The application ensures that termination of spawned OsPid
        leads to termination of the associated Erlang Pid, and vice
        versa.
  
<h2><a href="#top" name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-cmd">cmd()</a></h3>
<p><pre ><code class="language-erlang">cmd() = binary() | string() | [string()]</code></pre ></p>


<h3 class="typedecl"><a name="type-cmd_option">cmd_option()</a></h3>
<p><pre ><code class="language-erlang">cmd_option() = 
    monitor | sync | link |
    {executable, string() | binary()} |
    {cd, WorkDir :: string() | binary()} |
    {env,
     [string() |
      clear |
      {Name :: string() | binary(),
       Val :: string() | binary() | false},
      ...]} |
    {kill, KillCmd :: string() | binary()} |
    {kill_timeout, Sec :: non_neg_integer()} |
    kill_group |
    {group, GID :: string() | binary() | integer()} |
    {user, RunAsUser :: string() | binary()} |
    {nice, Priority :: integer()} |
    {success_exit_code, ExitCode :: integer()} |
    stdin |
    {stdin, null | close | string() | binary()} |
    stdout | stderr |
    {stdout, stderr | <a href="#type-output_dev_opt">output_dev_opt()</a>} |
    {stderr, stdout | <a href="#type-output_dev_opt">output_dev_opt()</a>} |
    {stdout | stderr, string() | binary(), [<a href="#type-output_file_opt">output_file_opt()</a>]} |
    pty | debug |
    {debug, integer()}</code></pre ></p>


<h3 class="typedecl"><a name="type-cmd_options">cmd_options()</a></h3>
<p><pre ><code class="language-erlang">cmd_options() = [<a href="#type-cmd_option">cmd_option()</a>]</code></pre ></p>


<h3 class="typedecl"><a name="type-exec_option">exec_option()</a></h3>
<p><pre ><code class="language-erlang">exec_option() = 
    debug |
    {debug, integer()} |
    root |
    {root, boolean()} |
    verbose |
    {args, [string() | binary(), ...]} |
    {alarm, non_neg_integer()} |
    {user, string() | binary()} |
    {limit_users, [string() | binary(), ...]} |
    {portexe, string() | binary()} |
    {env,
     [{string() | binary(), string() | binary() | false}, ...]}</code></pre ></p>


<h3 class="typedecl"><a name="type-exec_options">exec_options()</a></h3>
<p><pre ><code class="language-erlang">exec_options() = [<a href="#type-exec_option">exec_option()</a>]</code></pre ></p>


<h3 class="typedecl"><a name="type-osgid">osgid()</a></h3>
<p><pre ><code class="language-erlang">osgid() = integer()</code></pre ></p>
<p>  Representation of OS group ID.</p>

<h3 class="typedecl"><a name="type-ospid">ospid()</a></h3>
<p><pre ><code class="language-erlang">ospid() = integer()</code></pre ></p>
<p>  Representation of OS process ID.</p>

<h3 class="typedecl"><a name="type-output_dev_opt">output_dev_opt()</a></h3>
<p><pre ><code class="language-erlang">output_dev_opt() = 
    null | close | print |
    string() |
    pid() |
    fun((stdout | stderr, integer(), binary()) -&gt; none())</code></pre ></p>


<h3 class="typedecl"><a name="type-output_file_opt">output_file_opt()</a></h3>
<p><pre ><code class="language-erlang">output_file_opt() = append | {mode, Mode :: integer()}</code></pre ></p>


<h2><a href="#top" name="index">Function Index</a></h2>
<table class="tab" width="100%" class="tab" summary="function index"><tr class="tab"><td class="tab"><a href="#debug-1">debug/1</a></td><td class="tab">Set debug level of the port process.</td></tr>
<tr class="tab"><td class="tab"><a href="#kill-2">kill/2</a></td><td class="tab">Send a <code>Signal</code> to a child <code>Pid</code>, <code>OsPid</code> or an Erlang <code>Port</code>.</td></tr>
<tr class="tab"><td class="tab"><a href="#manage-2">manage/2</a></td><td class="tab"></td></tr>
<tr class="tab"><td class="tab"><a href="#ospid-1">ospid/1</a></td><td class="tab">Get <code>OsPid</code> of the given Erlang <code>Pid</code>.</td></tr>
<tr class="tab"><td class="tab"><a href="#pid-1">pid/1</a></td><td class="tab">Get <code>Pid</code> of the given <code>OsPid</code>.</td></tr>
<tr class="tab"><td class="tab"><a href="#run-2">run/2</a></td><td class="tab"></td></tr>
<tr class="tab"><td class="tab"><a href="#run-3">run/3</a></td><td class="tab">Run an external program.</td></tr>
<tr class="tab"><td class="tab"><a href="#run_link-2">run_link/2</a></td><td class="tab"></td></tr>
<tr class="tab"><td class="tab"><a href="#run_link-3">run_link/3</a></td><td class="tab">Run an external program and link to the OsPid.</td></tr>
<tr class="tab"><td class="tab"><a href="#send-2">send/2</a></td><td class="tab">Send <code>Data</code> to stdin of the OS process identified by <code>OsPid</code>.</td></tr>
<tr class="tab"><td class="tab"><a href="#setpgid-2">setpgid/2</a></td><td class="tab">Change group ID of a given <code>OsPid</code> to <code>Gid</code>.</td></tr>
<tr class="tab"><td class="tab"><a href="#signal-1">signal/1</a></td><td class="tab">Convert a signal number to atom.</td></tr>
<tr class="tab"><td class="tab"><a href="#signal_to_int-1">signal_to_int/1</a></td><td class="tab"></td></tr>
<tr class="tab"><td class="tab"><a href="#start-0">start/0</a></td><td class="tab">Start of an external program manager without supervision.</td></tr>
<tr class="tab"><td class="tab"><a href="#start-1">start/1</a></td><td class="tab"></td></tr>
<tr class="tab"><td class="tab"><a href="#start_link-1">start_link/1</a></td><td class="tab">Supervised start an external program manager.</td></tr>
<tr class="tab"><td class="tab"><a href="#status-1">status/1</a></td><td class="tab">Decode the program's exit_status.</td></tr>
<tr class="tab"><td class="tab"><a href="#stop-1">stop/1</a></td><td class="tab">Terminate a managed <code>Pid</code>, <code>OsPid</code>, or <code>Port</code> process.</td></tr>
<tr class="tab"><td class="tab"><a href="#stop_and_wait-2">stop_and_wait/2</a></td><td class="tab">Terminate a managed <code>Pid</code>, <code>OsPid</code>, or <code>Port</code> process, like
       <code>stop/1</code>, and wait for it to exit.</td></tr>
<tr class="tab"><td class="tab"><a href="#which_children-0">which_children/0</a></td><td class="tab">Get a list of children managed by port program.</td></tr>
<tr class="tab"><td class="tab"><a href="#winsz-3">winsz/3</a></td><td class="tab">Set the pty terminal <code>Rows</code> and <code>Cols</code> of the OS process identified by <code>OsPid</code>.</td></tr>
</table>

<h2><a href="#top" name="functions">Function Details</a></h2>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="debug-1">debug/1</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">debug(Level :: integer()) -&gt;
         {ok, OldLevel :: integer()} | {error, timeout}</code></pre ></p>
<p> </p>
</div><p>Set debug level of the port process.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="kill-2">kill/2</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">kill(Pid :: pid() | <a href="#type-ospid">ospid()</a>, Signal :: atom() | integer()) -&gt;
        ok | {error, any()}</code></pre ></p>
<p> </p>
</div><p>Send a <code>Signal</code> to a child <code>Pid</code>, <code>OsPid</code> or an Erlang <code>Port</code>.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="manage-2">manage/2</a></h3>
<div class="spec">
<p><tt>manage(Port, Options) -&gt; any()</tt></p>
<p> </p>
</div>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="ospid-1">ospid/1</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">ospid(Pid :: pid()) -&gt; <a href="#type-ospid">ospid()</a> | {error, Reason :: any()}</code></pre ></p>
<p> </p>
</div><p>Get <code>OsPid</code> of the given Erlang <code>Pid</code>.  The <code>Pid</code> must be created
       previously by running the run/2 or run_link/2 commands.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="pid-1">pid/1</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">pid(OsPid :: <a href="#type-ospid">ospid()</a>) -&gt; pid() | undefined | {error, timeout}</code></pre ></p>
<p> </p>
</div><p>Get <code>Pid</code> of the given <code>OsPid</code>.  The <code>OsPid</code> must be created
       previously by running the run/2 or run_link/2 commands.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="run-2">run/2</a></h3>
<div class="spec">
<p><tt>run(Exe, Options) -&gt; any()</tt></p>
<p> </p>
</div>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="run-3">run/3</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">run(Exe :: <a href="#type-cmd">cmd()</a>, Options :: <a href="#type-cmd_options">cmd_options()</a>, Timeout :: integer()) -&gt;
       {ok, pid(), <a href="#type-ospid">ospid()</a>} |
       {ok, [{stdout | stderr, [binary()]}]} |
       {error, any()}</code></pre ></p>
<p> </p>
</div><p>Run an external program. <code>OsPid</code> is the OS process identifier of
       the new process. If <code>sync</code> is specified in <code>Options</code> the return
       value is <code>{ok, Status}</code> where <code>Status</code> is OS process exit status.
       The <code>Status</code> can be decoded with <code>status/1</code> to determine the
       process's exit code and if it was killed by signal.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="run_link-2">run_link/2</a></h3>
<div class="spec">
<p><tt>run_link(Exe, Options) -&gt; any()</tt></p>
<p> </p>
</div>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="run_link-3">run_link/3</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">run_link(Exe :: <a href="#type-cmd">cmd()</a>,
         Options :: <a href="#type-cmd_options">cmd_options()</a>,
         Timeout :: integer()) -&gt;
            {ok, pid(), <a href="#type-ospid">ospid()</a>} |
            {ok, [{stdout | stderr, [binary()]}]} |
            {error, any()}</code></pre ></p>
<p> </p>
</div><p>Equivalent to <tt>run / 2</tt>.</p>
<p>Run an external program and link to the OsPid. If OsPid exits,
       the calling process will be killed or if it's trapping exits,
       it'll get {'EXIT', OsPid, Status} message.  If the calling process
       dies the OsPid will be killed.
       The <code>Status</code> can be decoded with <code>status/1</code> to determine the
       process's exit code and if it was killed by signal.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="send-2">send/2</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">send(OsPid :: <a href="#type-ospid">ospid()</a> | pid(), Data :: binary() | eof) -&gt; ok</code></pre ></p>
<p> </p>
</div><p><p>Send <code>Data</code> to stdin of the OS process identified by <code>OsPid</code>.</p>
 
  Sending eof instead of binary Data causes close of stdin of the
  corresponding process. Data sent to closed stdin is ignored.
 </p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="setpgid-2">setpgid/2</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">setpgid(OsPid :: <a href="#type-ospid">ospid()</a>, Gid :: <a href="#type-osgid">osgid()</a>) -&gt; ok | {error, any()}</code></pre ></p>
<p> </p>
</div><p>Change group ID of a given <code>OsPid</code> to <code>Gid</code>.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="signal-1">signal/1</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">signal(Num :: integer()) -&gt; atom() | integer()</code></pre ></p>
<p> </p>
</div><p>Convert a signal number to atom</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="signal_to_int-1">signal_to_int/1</a></h3>
<div class="spec">
<p><tt>signal_to_int(X1) -&gt; any()</tt></p>
<p> </p>
</div>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="start-0">start/0</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">start() -&gt; {ok, pid()} | {error, any()}</code></pre ></p>
<p> </p>
</div><p>Equivalent to <tt>start_link / 1</tt>.</p>
<p>Start of an external program manager without supervision.
       Note that the port program requires <code>SHELL</code> environment variable to
       be set.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="start-1">start/1</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">start(Options :: <a href="#type-exec_options">exec_options()</a>) -&gt; {ok, pid()} | {error, any()}</code></pre ></p>
<p> </p>
</div>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="start_link-1">start_link/1</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">start_link(Options :: <a href="#type-exec_options">exec_options()</a>) -&gt;
              {ok, pid()} | {error, any()}</code></pre ></p>
<p> </p>
</div><p>Supervised start an external program manager.
       Note that the port program requires <code>SHELL</code> environment variable to
       be set.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="status-1">status/1</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">status(Status :: integer()) -&gt;
          {status, ExitStatus :: integer()} |
          {signal,
           Singnal :: integer() | atom(),
           Core :: boolean()}</code></pre ></p>
<p> </p>
</div><p>Decode the program's exit_status.  If the program exited by signal
       the function returns <code>{signal, Signal, Core}</code> where the <code>Signal</code>
       is the signal number or atom, and <code>Core</code> indicates if the core file
       was generated.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="stop-1">stop/1</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">stop(Pid :: pid() | <a href="#type-ospid">ospid()</a> | port()) -&gt; ok | {error, any()}</code></pre ></p>
<p> </p>
</div><p>Terminate a managed <code>Pid</code>, <code>OsPid</code>, or <code>Port</code> process. The OS process is
       terminated gracefully.  If it was given a <code>{kill, Cmd}</code> option at
       startup, that command is executed and a timer is started.  If
       the program doesn't exit, then the default termination is
       performed.  Default termination implies sending a <code>SIGTERM</code> command
       followed by <code>SIGKILL</code> in 5 seconds, if the program doesn't get
       killed.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="stop_and_wait-2">stop_and_wait/2</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">stop_and_wait(Port :: pid() | <a href="#type-ospid">ospid()</a> | port(),
              Timeout :: integer()) -&gt;
                 term() | {error, any()}</code></pre ></p>
<p> </p>
</div><p>Terminate a managed <code>Pid</code>, <code>OsPid</code>, or <code>Port</code> process, like
       <code>stop/1</code>, and wait for it to exit.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="which_children-0">which_children/0</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">which_children() -&gt; [<a href="#type-ospid">ospid()</a>, ...]</code></pre ></p>
<p> </p>
</div><p>Get a list of children managed by port program.</p>

<h3 class="function"><a href="#index"><i class="arrow up"></i></a><a  class="function" name="winsz-3">winsz/3</a></h3>
<div class="spec">
<p><pre ><code class="language-erlang">winsz(OsPid :: <a href="#type-ospid">ospid()</a> | pid(),
      Rows :: integer(),
      Cols :: integer()) -&gt;
         ok</code></pre ></p>
<p> </p>
</div><p><p>Set the pty terminal <code>Rows</code> and <code>Cols</code> of the OS process identified by <code>OsPid</code>.</p>
 
  The process must have been created with the <code>pty</code> option.
 </p>
<hr>

</div>
</body>
</html>
